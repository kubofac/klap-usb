<!DOCTYPE html>
<html lang="ja">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta http-equiv="X-UA-Compatible" content="IE=edge">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>K-LAP_ï½¸ï¾ï¾ï¾Œï½§ï½¸ è¨­å®šãƒ„ãƒ¼ãƒ« (WebUSBå¯¾å¿œ)</title>
Â  Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
Â  Â  <link rel="manifest" href="/manifest.json">
Â  Â  <script>
Â  Â  Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  Â  Â  Â  Â  navigator.serviceWorker.register('/service-worker.js')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .then(registration => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('Service Worker registered! Scope:', registration.scope);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.log('Service Worker registration failed:', err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  </script>
Â  Â  <style>
Â  Â  Â  Â  /* CSSã¯å¤‰æ›´ãªã— */
Â  Â  Â  Â  #map-cntainer { position: relative; }
Â  Â  Â  Â  #mapid { height: 300px; width: 100%; margin-bottom: 15px; }
Â  Â  Â  Â  #map-controls {
Â  Â  Â  Â  Â  Â  position: absolute; top: 10px; right: 10px; z-index: 1000;
Â  Â  Â  Â  Â  Â  background-color: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
Â  Â  Â  Â  }
Â  Â  Â  Â  #map-controls button { padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; cursor: pointer; margin-right: 5px; }
Â  Â  Â  Â  #map-controls button.active { background-color: #007bff; color: white; }
Â  Â  Â  Â  body { font-family: sans-serif; padding: 20px; }
Â  Â  Â  Â  .form-group { margin-bottom: 15px; }
Â  Â  Â  Â  .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
Â  Â  Â  Â  .form-group input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; width: 200px; }
Â  Â  Â  Â  .form-group select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; width: 200px; }
Â  Â  Â  Â  .form-group button { padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; cursor: pointer; margin-right: 5px; }
Â  Â  Â  Â  #setSportkk, #setSportkkk, #setThresholdValue, #setLapCoolDown, #gps-frequency { margin-top: 10px; font-weight: bold; }
Â  Â  Â  Â  #clickCoordinates { font-weight: bold; }
Â  Â  Â  Â  #instructionMessage { font-weight: bold; min-height: 20px; }
Â  Â  </style>
</head>
<body>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="circuitSelect">ã‚µãƒ¼ã‚­ãƒƒãƒˆã‚’é¸æŠ:</label>
Â  Â  Â  Â  <select name="cir" id="circuitSelect">
Â  Â  Â  Â  Â  Â  <option value="">ã‚µãƒ¼ã‚­ãƒƒãƒˆã‚’é¸æŠ</option>
Â  Â  Â  Â  Â  Â  <option value="0">ç™½ç³¸S</option>
Â  Â  Â  Â  Â  Â  <option value="1">å¯Œå£«C</option>
Â  Â  Â  Â  Â  Â  <option value="2">ã¤ã¾æ‹</option>
Â  Â  Â  Â  Â  Â  <option value="3">ä¸­äº•C</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <p id="setSportkk"></p>
Â  Â  </div>

Â  Â  <div id="map-container">
Â  Â  Â  Â  <div id="mapid"></div>
Â  Â  Â  Â  <div id="map-controls">
Â  Â  Â  Â  Â  Â  <button id="setStartPointButton">é–‹å§‹ç‚¹ã‚’é…ç½®</button>
Â  Â  Â  Â  Â  Â  <button id="setEndPointButton" disabled>çµ‚äº†ç‚¹ã‚’é…ç½®</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="form-group">
Â  Â  Â  Â  <p id="instructionMessage"></p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="startLineP1Lon">é–‹å§‹ç‚¹ çµŒåº¦:</label>
Â  Â  Â  Â  <input type="number" id="startLineP1Lon" placeholder="çµŒåº¦" readonly>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="startLineP1Lat">é–‹å§‹ç‚¹ ç·¯åº¦:</label>
Â  Â  Â  Â  <input type="number" id="startLineP1Lat" placeholder="ç·¯åº¦" readonly>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="startLineP2Lon">çµ‚äº†ç‚¹ çµŒåº¦:</label>
Â  Â  Â  Â  <input type="number" id="startLineP2Lon" placeholder="çµŒåº¦" readonly>
Â  Â  </div>
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="startLineP2Lat">çµ‚äº†ç‚¹ ç·¯åº¦:</label>
Â  Â  Â  Â  <input type="number" id="startLineP2Lat" placeholder="ç·¯åº¦" readonly>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button onclick="saveStartLineCoordinates()">ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã‚’ä¿å­˜</button>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <p>GPSæ›´æ–°é »åº¦: <span id="gps-frequency">æœªæ¥ç¶š</span> Hz</p>
Â  Â  </div>
Â  Â Â 
Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="thresholdSelect">GPSé–¾å€¤ (ãƒ¡ãƒ¼ãƒˆãƒ«):</label>
Â  Â  Â  Â  <select name="threshold" id="thresholdSelect">
Â  Â  Â  Â  Â  Â  <option value="10">10m</option>
Â  Â  Â  Â  Â  Â  <option value="15">15m</option>
Â  Â  Â  Â  Â  Â  <option value="20">20m</option>
Â  Â  Â  Â  Â  Â  <option value="25">25m</option>
Â  Â  Â  Â  Â  Â  <option value="30">30m</option>
Â  Â  Â  Â  Â  Â  <option value="40">40m</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <p id="setThresholdValue"></p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button onclick="saveThreshold()">SET GPSé–¾å€¤</button>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <label for="lapCoolDownSelect">ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ (ç§’):</label>
Â  Â  Â  Â  <select name="coolDown" id="lapCoolDownSelect">
Â  Â  Â  Â  Â  Â  <option value="20000">20ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="30000">30ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="40000">40ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="50000">50ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="60000">60ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="90000">90ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="122000">120ç§’</option>
Â  Â  Â  Â  Â  Â  <option value="180000">180ç§’</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <p id="setLapCoolDown"></p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button onclick="saveLapCoolDown()">SET ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³</button>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button id="webUsbGpsConnectButton">WebUSB GPSæ¥ç¶š</button>
Â  Â  Â  Â  <button value="START" id="mybtn2" style="margin-left: 10px;">ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ã¸</button>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <p id="clickCoordinates">GPSãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ¥ç¶šã—ã¦ãã ã•ã„ã€‚</p>
Â  Â  </div>

Â  Â  <div class="form-group">
Â  Â  Â  Â  <button id="resetStorageButton">Reset All Settings</button>
Â  Â  </div>

Â  Â  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
Â  Â  <script src="circuit_data.js"></script>Â 
Â  Â Â 
Â  Â  <script>
Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  // WebUSB ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨è¨­å®š
Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  let device = null;
Â  Â  Â  Â  let keepReading = true;
Â  Â  Â  Â  let nmeaBuffer = '';
Â  Â  Â  Â Â 
Â  Â  Â  Â  // â˜…â˜…â˜… ä»¥å‰ã®ã‚„ã‚Šå–ã‚Šã§ç‰¹å®šã—ãŸGPSãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æƒ…å ± â˜…â˜…â˜…
Â  Â  Â  Â  const NMEA_VENDOR_ID = 0x1546;Â  Â 
Â  Â  Â  Â  const NMEA_PRODUCT_ID = 0x01A8;Â Â 
Â  Â  Â  Â  const IN_ENDPOINT = 1;Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

Â  Â  Â  Â  let webUsbWatchId = null; // WebUSBç›£è¦–ãƒ•ãƒ©ã‚° (æ¥ç¶šçŠ¶æ…‹ã®ç®¡ç†ç”¨)
Â  Â  Â  Â  let updateCounter = 0;Â 
Â  Â  Â  Â  let displayRateTimer = null;Â 
Â  Â  Â  Â  let lastPosition = null;Â 

Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  // Leaflet/è¨­å®š ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° (å¤‰æ›´ãªã—)
Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  var map;
Â  Â  Â  Â  var startPointMarker = null;
Â  Â  Â  Â  var endPointMarker = null;
Â  Â  Â  Â  var currentPositionMarker = null;
Â  Â  Â  Â  var startLinePolyline = null;
Â  Â  Â  Â  var pl1 = 1;Â 
Â  Â  Â  Â  var cir1 = "";
Â  Â  Â  Â  var gpsThreshold = 20;
Â  Â  Â  Â  var lapCoolDownTime = 30000;
Â  Â  Â  Â Â 
Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  // NMEA è§£æé–¢æ•° (sw.html ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯)
Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  function dmsToDecimal(dmm, direction) {
Â  Â  Â  Â  Â  Â  if (!dmm || dmm.length < 3) return NaN;
Â  Â  Â  Â  Â  Â  const degrees = parseInt(dmm.substring(0, dmm.indexOf('.') - 2));
Â  Â  Â  Â  Â  Â  const minutes = parseFloat(dmm.substring(dmm.indexOf('.') - 2));
Â  Â  Â  Â  Â  Â  let decimal = degrees + (minutes / 60);

Â  Â  Â  Â  Â  Â  if (direction === 'S' || direction === 'W') {
Â  Â  Â  Â  Â  Â  Â  Â  decimal = -decimal;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return decimal;
Â  Â  Â  Â  }

Â  Â  Â  Â  function parseNmeaLine(line) {
Â  Â  Â  Â  Â  Â  const parts = line.split(',');
Â  Â  Â  Â  Â  Â  // $GPRMC/$GNRMC ã® 'A' (Valid) ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
Â  Â  Â  Â  Â  Â  if ((parts[0].endsWith('RMC') || parts[0].endsWith('RMC')) && parts.length >= 10 && parts[2] === 'A') {
Â  Â  Â  Â  Â  Â  Â  Â  const lat = dmsToDecimal(parts[3], parts[4]);
Â  Â  Â  Â  Â  Â  Â  Â  const lon = dmsToDecimal(parts[5], parts[6]);
Â  Â  Â  Â  Â  Â  Â  Â  const speedKnot = parseFloat(parts[7]) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  const speedMps = speedKnot * 0.514444;Â 

Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(lat) || isNaN(lon)) return null;

Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  coords: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  latitude: lat,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  longitude: lon,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  speed: speedMps,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accuracy: 1
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timestamp: Date.now()Â 
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  }

Â  Â  Â  Â  function processNmeaData(data) {
Â  Â  Â  Â  Â  Â  nmeaBuffer += data;
Â  Â  Â  Â  Â  Â  let newlineIndex;

Â  Â  Â  Â  Â  Â  while ((newlineIndex = nmeaBuffer.indexOf('\n')) !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  const line = nmeaBuffer.substring(0, newlineIndex).trim();
Â  Â  Â  Â  Â  Â  Â  Â  nmeaBuffer = nmeaBuffer.substring(newlineIndex + 1);

Â  Â  Â  Â  Â  Â  Â  Â  if (line.startsWith('$') && line.length > 5) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const position = parseNmeaLine(line);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (position) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onWebUsbPositionUpdate(position);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  // WebUSB æ¥ç¶šãƒ»ç›£è¦–ãƒ»æ›´æ–°é–¢æ•°
Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â Â 
Â  Â  Â  Â  // WebUSBãƒ‡ãƒ¼ã‚¿èª­ã¿å–ã‚Šãƒ«ãƒ¼ãƒ—
Â  Â  Â  Â  async function readLoop() {
Â  Â  Â  Â  Â  Â  while (device && keepReading) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await device.transferIn(IN_ENDPOINT, 512);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (result.status === 'ok' && result.data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const decoder = new TextDecoder();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nmeaData = decoder.decode(result.data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  processNmeaData(nmeaData);Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (keepReading) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Read Loop Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('clickCoordinates').textContent = `ã‚¨ãƒ©ãƒ¼: USBé€šä¿¡æ–­ã€‚å†æ¥ç¶šã—ã¦ãã ã•ã„ã€‚`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;Â 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  stopGpsFrequencyMonitor();
Â  Â  Â  Â  }

Â  Â  Â  Â  // WebUSBæ¥ç¶šã‚’é–‹å§‹
Â  Â  Â  Â  async function startWebUsbGps() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('clickCoordinates').textContent = 'USBãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢ä¸­...';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  device = await navigator.usb.requestDevice({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  filters: [{ vendorId: NMEA_VENDOR_ID, productId: NMEA_PRODUCT_ID }]
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  await device.open();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (device.configuration === null) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await device.selectConfiguration(device.configurations[0].configurationValue);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // --- ğŸ’¡ ä¿®æ­£ç®‡æ‰€: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç•ªå·ã‚’ 0 ã‹ã‚‰ 1 ã«å¤‰æ›´ ---
Â  Â  Â  Â  Â  Â  Â  Â  const interfaceNumber = 1;Â 
Â  Â  Â  Â  Â  Â  Â  Â  await device.claimInterface(interfaceNumber);
Â  Â  Â  Â  Â  Â  Â  Â  // ----------------------------------------------------
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  webUsbWatchId = true;
Â  Â  Â  Â  Â  Â  Â  Â  keepReading = true;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('webUsbGpsConnectButton').textContent = 'GPS åˆ‡æ–­';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('clickCoordinates').textContent = 'GPSãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¥ç¶šå®Œäº†ã€‚ãƒ‡ãƒ¼ã‚¿å—ä¿¡ä¸­...';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  startRateMeasurement();Â 
Â  Â  Â  Â  Â  Â  Â  Â  readLoop();Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("WebUSB Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('clickCoordinates').textContent = `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('webUsbGpsConnectButton').textContent = 'WebUSB GPSæ¥ç¶š';
Â  Â  Â  Â  Â  Â  Â  Â  stopGpsFrequencyMonitor();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // GPSæ›´æ–°ãƒ¬ãƒ¼ãƒˆè¨ˆæ¸¬é–‹å§‹
Â  Â  Â  Â  function startRateMeasurement() {
Â  Â  Â  Â  Â  Â  if (displayRateTimer !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(displayRateTimer);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateCounter = 0;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  displayRateTimer = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  const frequency = updateCounter;Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('gps-frequency').textContent = frequency.toFixed(1);
Â  Â  Â  Â  Â  Â  Â  Â  updateCounter = 0;Â 
Â  Â  Â  Â  Â  Â  }, 1000);Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // GPSç›£è¦–ã‚’åœæ­¢
Â  Â  Â  Â  async function stopGpsFrequencyMonitor() {
Â  Â  Â  Â  Â  Â  if (displayRateTimer !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(displayRateTimer);
Â  Â  Â  Â  Â  Â  Â  Â  displayRateTimer = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('gps-frequency').textContent = 'æœªæ¥ç¶š';

Â  Â  Â  Â  Â  Â  keepReading = false;
Â  Â  Â  Â  Â  Â  if (device) {
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // --- ğŸ’¡ ä¿®æ­£ç®‡æ‰€ã«åˆã‚ã›ã¦ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ç•ªå·ã‚’ 1 ã«å¤‰æ›´ ---
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await device.releaseInterface(1); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ----------------------------------------------------
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await device.close();
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("USB Close Error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  device = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  webUsbWatchId = null;
Â  Â  Â  Â  Â  Â  document.getElementById('webUsbGpsConnectButton').textContent = 'WebUSB GPSæ¥ç¶š';
Â  Â  Â  Â  Â  Â  console.log('WebUSB GPSç›£è¦–ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚');
Â  Â  Â  Â  }

Â  Â  Â  Â  // NMEAãƒ‡ãƒ¼ã‚¿å—ä¿¡æ™‚ã®å‡¦ç† (åœ°å›³ä¸Šã®ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°ã¨é »åº¦è¨ˆæ¸¬)
Â  Â  Â  Â  function onWebUsbPositionUpdate(position) {
Â  Â  Â  Â  Â  Â  updateCounter++;

Â  Â  Â  Â  Â  Â  const currentLat = position.coords.latitude;
Â  Â  Â  Â  Â  Â  const currentLon = position.coords.longitude;
Â  Â  Â  Â  Â  Â  const currentLatLng = L.latLng(currentLat, currentLon);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // åœ°å›³ä¸Šã®ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
Â  Â  Â  Â  Â  Â  if (currentPositionMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  currentPositionMarker.setLatLng(currentLatLng);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  currentPositionMarker = L.circleMarker(currentLatLng, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  radius: 5,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  color: 'blue',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fillColor: '#007aff',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fillOpacity: 0.8
Â  Â  Â  Â  Â  Â  Â  Â  }).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  map.setView(currentLatLng, 18);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ç¾åœ¨åœ°åº§æ¨™ã‚’è¡¨ç¤º
Â  Â  Â  Â  Â  Â  document.getElementById('clickCoordinates').textContent =Â 
Â  Â  Â  Â  Â  Â  Â  Â  `ç¾åœ¨åœ°: ç·¯åº¦ ${currentLat.toFixed(6)}, çµŒåº¦ ${currentLon.toFixed(6)}`;

Â  Â  Â  Â  Â  Â  lastPosition = position;
Â  Â  Â  Â  }

Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  // Leaflet/UI é–¢æ•° (WebUSBã«åˆã‚ã›ã¦ä¿®æ­£)
Â  Â  Â  Â  // =========================================================================

Â  Â  Â  Â  function initMap() {
Â  Â  Â  Â  Â  Â  map = L.map('mapid');
Â  Â  Â  Â  Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
Â  Â  Â  Â  Â  Â  Â  Â  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
Â  Â  Â  Â  Â  Â  }).addTo(map);

Â  Â  Â  Â  Â  Â  // åˆæœŸä½ç½®ã‚’æ—¥æœ¬ä¸­å¿ƒä»˜è¿‘ã«è¨­å®š (WebUSBæ¥ç¶šå¾Œã«ç¾åœ¨åœ°ã¸ç§»å‹•)
Â  Â  Â  Â  Â  Â  map.setView([35.6812, 139.7671], 8);Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  // (onMarkerDragEnd, updateStartLinePolyline, saveStartLineCoordinates,Â 
Â  Â  Â  Â  //Â  saveThreshold, saveLapCoolDown, loadStored...é–¢æ•°ã¯å¤‰æ›´ãªã—)

Â  Â  Â  Â  // ãƒãƒ¼ã‚«ãƒ¼ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
Â  Â  Â  Â  function onMarkerDragEnd(e) {
Â  Â  Â  Â  Â  Â  const marker = e.target;
Â  Â  Â  Â  Â  Â  const latlng = marker.getLatLng();

Â  Â  Â  Â  Â  Â  if (marker === startPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lon').value = latlng.lng;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lat').value = latlng.lat;
Â  Â  Â  Â  Â  Â  Â  Â  marker.setPopupContent('é–‹å§‹ç‚¹<br>ç·¯åº¦: ' + latlng.lat.toFixed(6) + '<br>çµŒåº¦: ' + latlng.lng.toFixed(6)).openPopup();
Â  Â  Â  Â  Â  Â  Â  Â  console.log('é–‹å§‹ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æ›´æ–°ã—ã¾ã—ãŸ:', latlng);
Â  Â  Â  Â  Â  Â  } else if (marker === endPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lon').value = latlng.lng;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lat').value = latlng.lat;
Â  Â  Â  Â  Â  Â  Â  Â  marker.setPopupContent('çµ‚äº†ç‚¹<br>ç·¯åº¦: ' + latlng.lat.toFixed(6) + '<br>çµŒåº¦: ' + latlng.lng.toFixed(6)).openPopup();
Â  Â  Â  Â  Â  Â  Â  Â  console.log('çµ‚äº†ç‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æ›´æ–°ã—ã¾ã—ãŸ:', latlng);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  updateStartLinePolyline();
Â  Â  Â  Â  }

Â  Â  Â  Â  // ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã®ç·šã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
Â  Â  Â  Â  function updateStartLinePolyline() {
Â  Â  Â  Â  Â  Â  if (startLinePolyline) {
Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(startLinePolyline);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (startPointMarker && endPointMarker) {
Â  Â  Â  Â  Â  Â  Â  Â  const p1 = startPointMarker.getLatLng();
Â  Â  Â  Â  Â  Â  Â  Â  const p2 = endPointMarker.getLatLng();
Â  Â  Â  Â  Â  Â  Â  Â  startLinePolyline = L.polyline([p1, p2], { color: 'red', weight: 5, opacity: 0.7 }).addTo(map);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // æ—¢å­˜ã® loadCircuitStartLineFromData, saveStartLineCoordinates,Â 
Â  Â  Â  Â  // saveThreshold, saveLapCoolDown, resetStorageAndDisplay é–¢æ•°ã¯çœç•¥
Â  Â  Â  Â  // ... (çœç•¥ã•ã‚ŒãŸé–¢æ•°ç¾¤ã¯ã€å…ƒã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ãã®ã¾ã¾ä½¿ç”¨ã§ãã¾ã™) ...
Â  Â  Â  Â Â 
Â  Â  Â  Â  function saveStartLineCoordinates() {
Â  Â  Â  Â  Â  Â  const p1Lon = parseFloat(document.getElementById('startLineP1Lon').value);
Â  Â  Â  Â  Â  Â  const p1Lat = parseFloat(document.getElementById('startLineP1Lat').value);
Â  Â  Â  Â  Â  Â  const p2Lon = parseFloat(document.getElementById('startLineP2Lon').value);
Â  Â  Â  Â  Â  Â  const p2Lat = parseFloat(document.getElementById('startLineP2Lat').value);

Â  Â  Â  Â  Â  Â  if (!isNaN(p1Lon) && !isNaN(p1Lat) && !isNaN(p2Lon) && !isNaN(p2Lat)) {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('startLineP1Lon', p1Lon);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('startLineP1Lat', p1Lat);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('startLineP2Lon', p2Lon);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('startLineP2Lat', p2Lat);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  loadStoredStartLineCoordinates();
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'æ­£ã—ã„æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function saveThreshold() {
Â  Â  Â  Â  Â  Â  localStorage.setItem('gpsThreshold', gpsThreshold);
Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'GPSé–¾å€¤ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + gpsThreshold + "m";
Â  Â  Â  Â  }

Â  Â  Â  Â  function saveLapCoolDown() {
Â  Â  Â  Â  Â  Â  localStorage.setItem('lapCoolDownTime', lapCoolDownTime);
Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'ãƒ©ãƒƒãƒ—ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ: ' + (lapCoolDownTime / 1000) + "ç§’";
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // localStorageã‹ã‚‰ã®ãƒ­ãƒ¼ãƒ‰é–¢æ•°
Â  Â  Â  Â  function loadStoredStartLineCoordinates() {
Â  Â  Â  Â  Â  Â  const slP1Lon = localStorage.getItem('startLineP1Lon');
Â  Â  Â  Â  Â  Â  const slP1Lat = localStorage.getItem('startLineP1Lat');
Â  Â  Â  Â  Â  Â  const slP2Lon = localStorage.getItem('startLineP2Lon');
Â  Â  Â  Â  Â  Â  const slP2Lat = localStorage.getItem('startLineP2Lat');

Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lon').value = slP1Lon || '';
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lat').value = slP1Lat || '';
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lon').value = slP2Lon || '';
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lat').value = slP2Lat || '';

Â  Â  Â  Â  Â  Â  if (slP1Lon && slP1Lat && slP2Lon && slP2Lat) {
Â  Â  Â  Â  Â  Â  Â  Â  const p1 = L.latLng(parseFloat(slP1Lat), parseFloat(slP1Lon));
Â  Â  Â  Â  Â  Â  Â  Â  const p2 = L.latLng(parseFloat(slP2Lat), parseFloat(slP2Lon));
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = false;

Â  Â  Â  Â  Â  Â  Â  Â  if (startPointMarker) map.removeLayer(startPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  if (endPointMarker) map.removeLayer(endPointMarker);

Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker = L.marker(p1, { draggable: true }).addTo(map)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .bindPopup('ä¿å­˜ã•ã‚ŒãŸé–‹å§‹ç‚¹<br>ç·¯åº¦: ' + p1.lat.toFixed(6) + '<br>çµŒåº¦: ' + p1.lng.toFixed(6))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .openPopup();
Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker.on('dragend', onMarkerDragEnd);

Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker = L.marker(p2, { draggable: true }).addTo(map)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .bindPopup('ä¿å­˜ã•ã‚ŒãŸçµ‚äº†ç‚¹<br>ç·¯åº¦: ' + p2.lat.toFixed(6) + '<br>çµŒåº¦: ' + p2.lng.toFixed(6))
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .openPopup();
Â  Â  Â  Â  Â  Â  Â  Â  endPointMarker.on('dragend', onMarkerDragEnd);

Â  Â  Â  Â  Â  Â  Â  Â  updateStartLinePolyline();
Â  Â  Â  Â  Â  Â  Â  Â  console.log('ä¿å­˜ã•ã‚ŒãŸã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', p1, p2);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  if (startPointMarker) map.removeLayer(startPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  if (endPointMarker) map.removeLayer(endPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  if (startLinePolyline) map.removeLayer(startLinePolyline);
Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker = null; endPointMarker = null; startLinePolyline = null;
Â  Â  Â  Â  Â  Â  Â  Â  console.log('localStorageã«ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³åº§æ¨™ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function loadStoredThreshold() {
Â  Â  Â  Â  Â  Â  const storedThreshold = localStorage.getItem('gpsThreshold');
Â  Â  Â  Â  Â  Â  if (storedThreshold) {
Â  Â  Â  Â  Â  Â  Â  Â  gpsThreshold = Number(storedThreshold);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("thresholdSelect").value = storedThreshold;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setThresholdValue").textContent = gpsThreshold + "m";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  gpsThreshold = 20;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("thresholdSelect").value = 20;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setThresholdValue").textContent = gpsThreshold + "m";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadStoredLapCoolDown() {
Â  Â  Â  Â  Â  Â  const storedLapCoolDown = localStorage.getItem('lapCoolDownTime');
Â  Â  Â  Â  Â  Â  if (storedLapCoolDown) {
Â  Â  Â  Â  Â  Â  Â  Â  lapCoolDownTime = Number(storedLapCoolDown);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("lapCoolDownSelect").value = storedLapCoolDown;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setLapCoolDown").textContent = (lapCoolDownTime / 1000) + "ç§’";
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  lapCoolDownTime = 30000;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("lapCoolDownSelect").value = 30000;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setLapCoolDown").textContent = (lapCoolDownTime / 1000) + "ç§’";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadStoredCircuit() {
Â  Â  Â  Â  Â  Â  const storedCircuit = localStorage.getItem('cir1');
Â  Â  Â  Â  Â  Â  const circuitSelectElement = document.getElementById("circuitSelect");
Â  Â  Â  Â  Â  Â  if (storedCircuit) {
Â  Â  Â  Â  Â  Â  Â  Â  cir1 = storedCircuit;
Â  Â  Â  Â  Â  Â  Â  Â  const optionToSelect = Array.from(circuitSelectElement.options).find(option => option.text === storedCircuit);
Â  Â  Â  Â  Â  Â  Â  Â  if (optionToSelect) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  circuitSelectElement.value = optionToSelect.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = cir1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  circuitSelectElement.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = "æœªé¸æŠ";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  circuitSelectElement.value = "";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = "æœªé¸æŠ";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadCircuitStartLineFromData(circuitId) {
Â  Â  Â  Â  Â  Â  if (typeof circuitData !== 'undefined' && circuitData && circuitData[circuitId]) {
Â  Â  Â  Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p1: circuitData[circuitId].startLineP1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  p2: circuitData[circuitId].startLineP2
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  return { p1: [0, 0], p2: [0, 0] };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Function to reset all stored data and update UI
Â  Â  Â  Â  function resetStorageAndDisplay() {
Â  Â  Â  Â  Â  Â  if (confirm('ã™ã¹ã¦ã®ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('startLineP1Lon');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('startLineP1Lat');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('startLineP2Lon');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('startLineP2Lat');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('pl1'); // pl1ã®ä¿å­˜/ãƒ­ãƒ¼ãƒ‰ãŒçœç•¥ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ä¸€å¿œæ®‹ã™
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('cir1');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('gpsThreshold');
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('lapCoolDownTime');

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lon').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lat').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lon').value = '';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lat').value = '';

Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("circuitSelect").value = "";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = "æœªé¸æŠ";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("thresholdSelect").value = "20";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setThresholdValue").textContent = "20m";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("lapCoolDownSelect").value = "30000";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("setLapCoolDown").textContent = "30ç§’";
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('clickCoordinates').textContent = 'GPSãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ¥ç¶šã—ã¦ãã ã•ã„ã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('instructionMessage').textContent = 'ã™ã¹ã¦ã®è¨­å®šãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = true;

Â  Â  Â  Â  Â  Â  Â  Â  if (startPointMarker) map.removeLayer(startPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  if (endPointMarker) map.removeLayer(endPointMarker);
Â  Â  Â  Â  Â  Â  Â  Â  if (startLinePolyline) map.removeLayer(startLinePolyline);
Â  Â  Â  Â  Â  Â  Â  Â  startPointMarker = null; endPointMarker = null; startLinePolyline = null;
Â  Â  Â  Â  Â  Â  Â  Â  console.log('All stored data has been reset.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // =========================================================================
Â  Â  Â  Â  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
Â  Â  Â  Â  // =========================================================================

Â  Â  Â  Â  const circuitSelect = document.getElementById("circuitSelect");
Â  Â  Â  Â  circuitSelect.addEventListener("change", function (e) {
Â  Â  Â  Â  Â  Â  const stg = circuitSelect.value;
Â  Â  Â  Â  Â  Â  const startLine = loadCircuitStartLineFromData(stg);
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lon').value = startLine.p1[0];
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP1Lat').value = startLine.p1[1];
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lon').value = startLine.p2[0];
Â  Â  Â  Â  Â  Â  document.getElementById('startLineP2Lat').value = startLine.p2[1];
Â  Â  Â  Â  Â  Â  cir1 = (typeof circuitData !== 'undefined' && circuitData[stg]?.name) || "";
Â  Â  Â  Â  Â  Â  document.getElementById("setSportkk").textContent = cir1 || "æœªé¸æŠ";
Â  Â  Â  Â  Â  Â  document.getElementById('setEndPointButton').disabled = false;
Â  Â  Â  Â  Â  Â  localStorage.setItem('cir1', cir1);

Â  Â  Â  Â  Â  Â  const p1 = L.latLng(startLine.p1[1], startLine.p1[0]);
Â  Â  Â  Â  Â  Â  const p2 = L.latLng(startLine.p2[1], startLine.p2[0]);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (startPointMarker) map.removeLayer(startPointMarker);
Â  Â  Â  Â  Â  Â  if (endPointMarker) map.removeLayer(endPointMarker);

Â  Â  Â  Â  Â  Â  startPointMarker = L.marker(p1, { draggable: true }).addTo(map)
Â  Â  Â  Â  Â  Â  Â  Â  .bindPopup('é–‹å§‹ç‚¹<br>ç·¯åº¦: ' + p1.lat.toFixed(6) + '<br>çµŒåº¦: ' + p1.lng.toFixed(6))
Â  Â  Â  Â  Â  Â  Â  Â  .openPopup();
Â  Â  Â  Â  Â  Â  startPointMarker.on('dragend', onMarkerDragEnd);

Â  Â  Â  Â  Â  Â  endPointMarker = L.marker(p2, { draggable: true }).addTo(map)
Â  Â  Â  Â  Â  Â  Â  Â  .bindPopup('çµ‚äº†ç‚¹<br>ç·¯åº¦: ' + p2.lat.toFixed(6) + '<br>çµŒåº¦: ' + p2.lng.toFixed(6))
Â  Â  Â  Â  Â  Â  Â  Â  .openPopup();
Â  Â  Â  Â  Â  Â  endPointMarker.on('dragend', onMarkerDragEnd);

Â  Â  Â  Â  Â  Â  updateStartLinePolyline();
Â  Â  Â  Â  Â  Â  map.fitBounds(L.latLngBounds(p1, p2).pad(0.5));
Â  Â  Â  Â  });

Â  Â  Â  Â  const thresholdSelect = document.getElementById("thresholdSelect");
Â  Â  Â  Â  thresholdSelect.addEventListener("change", function (e) {
Â  Â  Â  Â  Â  Â  gpsThreshold = Number(thresholdSelect.value);
Â  Â  Â  Â  Â  Â  document.getElementById("setThresholdValue").textContent = gpsThreshold + "m";
Â  Â  Â  Â  Â  Â  localStorage.setItem('gpsThreshold', gpsThreshold);
Â  Â  Â  Â  });

Â  Â  Â  Â  const lapCoolDownSelect = document.getElementById("lapCoolDownSelect");
Â  Â  Â  Â  lapCoolDownSelect.addEventListener("change", function (e) {
Â  Â  Â  Â  Â  Â  lapCoolDownTime = Number(lapCoolDownSelect.value);
Â  Â  Â  Â  Â  Â  document.getElementById("setLapCoolDown").textContent = (lapCoolDownTime / 1000) + "ç§’";
Â  Â  Â  Â  Â  Â  localStorage.setItem('lapCoolDownTime', lapCoolDownTime);
Â  Â  Â  Â  });

Â  Â  Â  Â  let button2 = document.getElementById('mybtn2');
Â  Â  Â  Â  button2.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  open('klap-usb.html'); // ãƒ©ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.getElementById('resetStorageButton').addEventListener('click', resetStorageAndDisplay);

Â  Â  Â  Â  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
Â  Â  Â  Â  window.onload = function () {
Â  Â  Â  Â  Â  Â  initMap();
Â  Â  Â  Â  Â  Â  loadStoredStartLineCoordinates();
Â  Â  Â  Â  Â  Â  // loadStoredPulseCount(); ã¯ HTML ã«è¦ç´ ãŒãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—
Â  Â  Â  Â  Â  Â  loadStoredCircuit();
Â  Â  Â  Â  Â  Â  loadStoredThreshold();
Â  Â  Â  Â  Â  Â  loadStoredLapCoolDown();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // WebUSBæ¥ç¶šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
Â  Â  Â  Â  Â  Â  document.getElementById('webUsbGpsConnectButton').addEventListener('click', function() {
Â  Â  Â  Â  Â  Â  Â  Â  if (!webUsbWatchId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  startWebUsbGps(); // WebUSBæ¥ç¶šã‚’é–‹å§‹
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stopGpsFrequencyMonitor(); // WebUSBæ¥ç¶šã‚’åˆ‡æ–­
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  };
Â  Â  </script>
</body>

</html>
